---
title: "Characteristics of Recent Mexican Immigrants to the United States that Influence Household Income"
subtitle: "Regression Analysis"
author: "Ben 10"
date: "November 20, 2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r load-packages}
library(tidyverse)
library(broom)
library(leaps)
library(knitr)
library(dplyr)
library(rms)
```

```{r data}
data <- read_csv("/cloud/project/03-regression-analysis/data.csv")
```

## 1. Introduction

We are aiming to build a model to determine which characteristics of Mexican immmigrants to the United States, specifically California, well-explain variation in household income. We will be building a multiple linear regression model to predict household income considering the following variables: `sex`, `relhead`, `age`, `statebrn`, `marstat`, `edyrs`, `occtype`, `usdur1`, `usdurl`, `usdoc1`, `uscity`, `yrborn`.

Our response variable is household income: the total income for a single household, reported in $USD. 


## 2. Exploratory Data Analysis


```{r caldata}
caldata <- data %>%
  filter(usstatel == "California")

caldata <- caldata%>%
  na.omit()

```

```{r nonfilt-income-plot}
ggplot(data = caldata, aes(x = log(hhincome))) +
  geom_histogram(binwidth = .7)+
  labs(title = "Distribution of Log(Household Income)", x= "log(Household Income)", y = "Count")
```

Originally, the distribution of log(Household Income)- our response variable- was bimodal and had a mean of 412,647 dollars. We determined that this is an absurdly high median income for a survey of largely undocumented immigrants in the US and believe that a significant chunk of the high incomes were actually recorded in pesos. We will filter out the incomes above 60,000 to remove what appears to be a second distribution of incomes in pesos. We will also remove incomes of zero from our dataset.

```{r filter-hhincome}
caldata <- caldata %>%
  mutate(hhincome = case_when(
    hhincome == .1 ~ 0,
    TRUE ~ hhincome
  )) #undoing mutation from proposal to return 0 income variables to 0
caldata <- caldata %>%
  filter(hhincome > 5, log(hhincome) < 8)
```


```{r hhincome-distribution}
ggplot(data = caldata, aes(x = hhincome)) +
  geom_histogram(binwidth = 100) +
  labs(title = "Distribution of Household Income", x= "Household Income", y = "Count")
```

```{r cities, fig.align="center"}
caldata <- caldata %>%
  filter(uscity %in% c("Bakersfield, CA","Bakersfield, CA", "Fresno, CA", "Los Angeles-Long Beach, CA", "Merced, CA","Orange County, CA","Riverside-San Bernardino, CA", "Sacramento, CA", "San Diego, CA", "San Francisco, CA", "San Jose, CA","Santa Barbara-Santa Maria-Lompoc, CA","Santa Cruz-Watsonville, CA","Vallejo-Fairfield-Napa, CA","Ventura, CA"))
ggplot(data = caldata, aes(x = uscity))+ 
  geom_bar() +
  coord_flip()+
  labs(title = "Distribution of Cities in California", x = "City", y = "Count")
```

These immigrants to California arrived to the following cities: Los Angeles-Long Beach, San Francisco, San Diego, Santa Cruz-Watsonville, Bakersfield, Fresno, Merced, Orange County, Riverside-San Bernardino, Sacramento, San Jose, Santa Barbara-Santa Maria-Lompoc, Vallejo-Fairfield-Napa, and Ventura. Given the comparatively small number of cases in which no city was reported, we deleted these instances. This leaves 15 unique locations in California. The majority of immigrants went to LA-Long Beach area. 

It turned out that all values from relhead in our cleaned data were "1" or head. So we will remove this variable, as well as state variables since we are only using California data. We will also remove place data since we are using uscity, and occ since we are using occtype.

```{r remove-relhead}
caldata <- subset(caldata, select = -c(relhead, usstatel, usstate1,usplace1, usplacel,occ) )
```

We must center age and usdurl in order to interpret them.

```{r}
mean(caldata$age) #mean age
mean(caldata$usdurl) #mean usdurl
```

The mean age in the dataset is 39.43 years and the mean duration of last US migration is 60.27 months (about 5 years).

```{r age-usdurl-cent}
caldata <- caldata %>%
  mutate(age=age-mean(age))
caldata <- caldata %>%
  mutate(usdurl=usdurl-mean(usdurl))
```

## 2. Multiple Linear Regression Model

In an effort to explain which characteristics of candidates influence their household income, we will be using a multiple linear regression model. Since our response variable is numerical with mulitple potential predictors, this is the best model at our disposal for us to use.

We will consider the potential interaction between principal occupation and number of years of school completed, since those are generally interconnected. We may also consider the interaction between documentation type and occupation type, although the effect may be insignificant.

We will select our model using AIC criteria, because since we're dealing with people, we want to build a model that accounts for volatile human nature and the ever-changing socioeconomic and political climate that could influence someone's household income. AIC is used when we would rather say a variable is a relevant predictor, when in reality it might not be and so in this case, we would rather err on the side of a false positive because we are dealing with a constantly fluctuating issue.

### 2.1 Full Model

```{r yrborn-age, fig.align = "center"}
ggplot(data = caldata, mapping = aes(x = yrborn, y = age)) +
  geom_point()+
  labs(title = "Correlation Between Age and Year Born", x = "Year Born", y = "Age")
```

`yrborn` and `age` provide the same information and are perfectly linear, therefore we decided to remove `yrborn` from consideration in the model.

```{r model}
full <- lm(hhincome ~ sex + age + statebrn + marstat + edyrs + occtype + usdur1 + usdurl + usdoc1 + uscity, data=caldata)
kable(tidy(full),format="html" ,digits=3)
```

### 2.2 Backward selection

```{r backward-selection}
reduced <- step(full, direction = "backward")
sel_summary <- summary(reduced)
tidy(reduced, exponentiate = FALSE, conf.int = TRUE) %>%
kable(digits = 3, format = "markdown")
```

### 2.3 Interactions

```{r int-model}
int_model_1 <- lm(hhincome ~ sex + age + edyrs + usdurl + edyrs*usdurl, data = caldata)
anova(reduced, int_model_1, test = "Chisq") %>% 
  kable(format = "markdown", digits = 3)  # p = 0.653

int_model_2 <- lm(hhincome ~ sex + age + edyrs + usdurl + sex*usdurl, data = caldata)
anova(reduced, int_model_2, test = "Chisq") %>% 
  kable(format = "markdown", digits = 3) # p = 0.034

int_model_3 <- lm(hhincome ~ sex + age + edyrs + usdurl + age*usdurl, data = caldata)
anova(reduced, int_model_3, test = "Chisq") %>% 
  kable(format = "markdown", digits = 3)  # p = 0.201

int_model_4 <- lm(hhincome ~ sex + age + edyrs + usdurl + sex*edyrs, data = caldata)
anova(reduced, int_model_4, test = "Chisq") %>% 
  kable(format = "markdown", digits = 3)  # p = 0.326

int_model_5 <- lm(hhincome ~ sex + age + edyrs + usdurl + age*edyrs, data = caldata)
anova(reduced, int_model_5, test = "Chisq") %>% 
  kable(format = "markdown", digits = 3)  # p = 0

int_model_6 <- lm(hhincome ~ sex + age + edyrs + usdurl + age*sex, data = caldata)
anova(reduced, int_model_6, test = "Chisq") %>% 
  kable(format = "markdown", digits = 3)  # p = 0.376
```

Through nested F-test, we observed significant interactions between age & edyrs and between sex & usdurl, with respective p-values of 0 and 0.034.

### 2.4 Model with Interaction

```{r final-model}
reduced_int <- lm(hhincome ~ sex + age + edyrs + usdurl + age*edyrs + sex*usdurl, data=caldata)
kable(tidy(reduced_int),format="html" ,digits=3)
```

### 2.5 Backward Selection with Interaction

Since we observed 2 pairs of significant interactions, we will do the backward selection again with the new interaction terms.

```{r}
full_int <- lm(hhincome ~ sex + age + statebrn + marstat + edyrs + occtype + usdur1 + usdurl + usdoc1 + uscity + sex*usdurl + age*edyrs , data=caldata)
kable(tidy(full_int),format="html" ,digits=3)
```

```{r}
reduced_int_new <- step(full_int, direction = "backward")
sel_summary <- summary(reduced_int_new)
tidy(reduced_int_new, exponentiate = FALSE, conf.int = TRUE) %>%
kable(digits = 3, format = "markdown")
```

We observed that the variable selection changed. Specifically, usdur1 and usdoc1 are significant, besides the 4 variables identified previously.





## 3. Check Assumtpions

Before interpreting the model, it is essential to check the assumptions.

### 3.1 Linearity

### 3.1.1 Predicted vs. Factors

```{r scatter-pairs}
pairs(hhincome ~ age + edyrs + usdurl + usdur1 , data = caldata,
      lower.panel = NULL)
```

```{r income-sex-plot}
ggplot(data = caldata, aes(x = as.factor(sex), y = hhincome))+
         geom_boxplot()+
  labs(title = "Boxplot of Household Income against Sex", x = "Sex", y = "Household income")

```

From the above plots, there seems to be a weak linear relationship between the response and predictor variables.

We also observe that there is a distinct linear relationship between usdurl and usdur1, which makes sense, because many people's first migration is their last migration. (they have only migrated to the US once.)

Hence, it is worth looking at VIF of the variables:

#### 3.1.2 Multicollinearity
```{r}
vif(reduced_int_new)
vif(reduced_int)
```

The VIF of usdurl and sex:usdurl are greater than 10, which is alarming. The high VIF of usdurl is likely due to its collinearity with usdur1. However, looking at the VIF for reduced_int model, the VIF for usdurl is still high, meaning that it actually have something to do with the interaction term "sex*usdurl".


### 3.2 Constant Variance

### 3.2.1 Residuals vs. Factors

```{r add-residuals}
caldata <- caldata %>% 
  mutate(predicted = predict.lm(reduced_int_new), residuals = resid(reduced_int_new))
```

Below is the plots of residuals against each quantitative predictor:

```{r factor_residual_scatterplot}
pairs(residuals ~ age + usdurl + edyrs, data = caldata,
      lower.panel = NULL) 
```

From the pairs plot above, there is a possibility that the constant variance for 'usdurl' is violated, because the scatterplot shows a reserved-fan shape. However, this could also be due to the fact that we have more data points on the lower range as compared to the upper range. Even though, the data looks sparser on the right, the spread is still large.

We believe that this violation of constant variance may result from certain migration patterns- seasonal workers which come to the US for a short period of time would expect to see different household incomes than long-term migrants. We can examine the distribution of duration of last US migration.

```{r usdurl-plot}
ggplot(data = caldata, aes(x = usdurl)) +
  geom_histogram() +
  labs(title = "Distribution of Last Migration to US (Mean-Centered)", x = "Duration - 60.27 months (months)")
```

```{r create-seasonal-var}
caldata <- caldata %>%
  mutate(seasonal = case_when(
    usdurl < 6 - 60.27 ~ "Y", #Workers with duration of migration < 6 months will be considered seasonal
    TRUE ~ "N"
  ))

caldata %>%
  count(seasonal)

ggplot(data = caldata, aes(x = seasonal, y = usdurl)) +
  geom_boxplot() +
  labs(title = "Distribution of Duration of Last US Migration", x = "Seasonal Worker?", y = 
         "Duration of Last US Migration (Mean-Centered) (months)")
ggplot(data = caldata, aes(x = seasonal, y = hhincome)) +
  geom_boxplot() +
  labs(title = "Distribution of Household Income", x = "Seasonal Worker?", y = 
         "Household Income (dollars)")
```


We create a new categorical variable called `seasonal` to classify migrants with a last US migration shorter than 6 months as seasonal workers. Roughly a quarter of the migrants in the dataset fall into this category.


Hence we fit our new full model:

```{r}
full_seasonal <- lm(hhincome ~ sex + age + statebrn + marstat + edyrs + occtype + usdur1 + usdurl + usdoc1 + uscity + sex*usdurl + age*edyrs + seasonal , data=caldata)
kable(tidy(full_seasonal),format="html" ,digits=3)
```

backward selection:

```{r}
reduced_seasonal <- step(full_seasonal, direction = "backward")
sel_summary <- summary(reduced_seasonal)
tidy(reduced_seasonal, exponentiate = FALSE, conf.int = TRUE) %>%
kable(digits = 3, format = "markdown")
```

The backward selection gave the same output as before, indicating that the indicator "seasonal" is not significant enough for us to include it in the final model.

Hence, we proceed with the rest of our assumption checking.


Below is the graph of residuals against categorical predictor:

```{r floorCat_residual}
ggplot(data=caldata,aes(x=as.factor(sex),y=residuals)) + 
  geom_boxplot() + 
  geom_hline(yintercept=0,color="red") +
  labs(x = "Sex", 
       y="Residuals",
       title= "Boxplot of Residuals vs. Sex")
```

From the pairs scatterplot, we cannot observe any clear patterns; and from the boxplot, the median of each category seems to be slightly less than 0. While the plot of male is relatively symmetrical, that of female is right skewed.

#### 3.2.2 Residual vs. Predicted

```{r residuel-predicted-scatterplot}
caldata <- caldata %>% 
  mutate(predicted = predict.lm(reduced_int_new), residuals = resid(reduced_int_new))
ggplot(data=caldata,aes(x=predicted, y=residuals)) + 
  geom_point() + 
  geom_hline(yintercept=0,color="red") +
  labs(title="Residuals vs. Predicted Household Income")
```

The residual vs. predicted values scatterplot shows no discernible patterns. There is a clustering of predictions between $500 and $1000, which makes sense because our input data does not have a lot of rich households.

Overall, the graphs confirm the constant variance assumption is satisfied.


### 3.3 Normality

#### 3.3.1 Histogram of Residuals

```{r histogram-residuals}
ggplot(data=caldata, mapping=aes(x=residuals)) + 
  geom_histogram() +
  labs(title="Distribution of Residuals", x="Residual")
```

#### 3.3.2 Normal-QQ Plot of Residuals

```{r qqplot}
ggplot(data=caldata,mapping=aes(sample=residuals)) +
  stat_qq() +
  stat_qq_line() +
  labs(title="Normal QQ Plot of Residuals")
```

From the histogram, the shape of distribution of residuals has a right skew. The Normal-QQ plot supports this finding, as the left half of the line follows closely the theoretical diagonal, yet the right half deviates from diagonal, showing that the right tail is skewed. Since we have 513 observations, the model is robust enough to tolerate deviation from normal.

### 3.4 Independence

Since we only included observations of heads of household, there will not be dependence caused by similar demographics between family members. However, some interdependence may arise since all observations are geographically close to each other. 

## 4. Interpretations

Our final model is hhincome=435.9118185+279.468261sexM-6.969323age+25.408001edyrs+1.880793usdurl+2.575527age:edyrs-1.492899sexM:usdurl

interpretation of coefficient:
All else constant, as compared to a female, a male's household income increases by $279.468261;
All else constant, with each year of increase in age, the household income decrease by $6.969323;
All else constant, with each year of increase in years of education, the household income increases by $25.408001;
All else constant, with each month of increase in duration in the US, the household income increases by $2.575527.


Our model expects an average household income of $435.63 for female Mexican migrants at age 39 with no years of education and a duration of 60.27 months for last US migration, all else held constant.

For every increase of one year in age above 39.4, all else held constant, we expect to see a decrease of 6.97 dollars in average household income.

For every increase of one year in education, all else held constant, we expect to see an increase of 25.41 dollars in average household income.

For male immigrants as compared to female immigrants, we expect to see an increase of 279.47 dollars in average household income, all else held constant.

Interpret age:edyrs interaction???

For every increase of one month in duration of last US migration above 60.27 months, we expect to see an increase of around 1.88 dollars in income for women and a (lesser) increase of 0.34 dollars in income for men.

Our baseline is an average aged women with no education who has spent an average amount of time in the US.

We note that being male increases expected income. This may have to do with the gender wage gap, but more likely has to do with the type of labour immigrants tend to do: often, this is physical labour that men, who on average are larger, are more capable of performing. Similarly, we would expect elderly immigrants to struggle with hard labour, and we note that income falls as age increases. 

As anticipated, more years of education increased income significantly. 

The more time an immigrant had been in the US, the more income they could expect to earn -- this may have to do with the advantages of having networks and stability, as well as overcoming language and cultural barriers. 

## 5. Additional Work


















Your regression analysis results go here. At a minimum, the regression analysis should include the following: 

- Statement of the research question and modeling obejctive (prediction, inference, etc.)

- Description of the response variable

- Updated exploratory data analysis, incorporating any feedback from the proposal
- Explanation of the modeling process and why you chose those metohds, incorporating any feedback from the proposal
- Output of the final model
- Discussion of the assumptions for the final model
- Interpretations / interesting findings from the model coefficients
- Additional work of other models or analylsis not included in the final model.

*Use proper headings as needed.*